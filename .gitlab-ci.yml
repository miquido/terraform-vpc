---
include:
  - remote: "https://raw.githubusercontent.com/miquido/gitlab-templates/1.3.80/terraform-toolkit.yml"
  - remote: "https://raw.githubusercontent.com/miquido/gitlab-templates/1.3.86/git-toolkit.yml"
  - remote: "https://raw.githubusercontent.com/miquido/gitlab-templates/1.3.86/gitlab-toolkit.yml"

.validate-terraform2:
  variables:
    ENVIRONMENTS: prod
    TF_VERSION: 1.3.7
  image:
    name: hashicorp/terraform:$TF_VERSION
    entrypoint:
      - ""
  script:
    - git config --global \url."https://${GITLAB_TERRAFORM_DEPLOY_TOKEN_USERNAME}:${GITLAB_TERRAFORM_DEPLOY_TOKEN_SECRET}@gitlab.com/miquido/terraform".insteadOf "ssh://git@gitlab.com/miquido/terraform"  # yamllint disable-line rule:line-length
    - git config --global url."https://github.com".insteadOf "ssh://git@github.com"
    - apk add python3
    - apk add --update py-pip
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install miquido_terraform_environments_check
    - python3 -m miquido_terraform_environments_check
  tags:
    - miquido
    - docker


get-latest-terraform:
  extends: .get-latest-terraform

check-formatting:
  extends: .check-formatting

validate:
  extends: .validate-terraform2
  variables:
    ENVIRONMENTS: examples/complete
    TF_VERSION: 1.6.5

miquido-ci-schema-validation:
  extends: .miquido-ci-schema-validation

bump-tag:
  extends: .bump_minor_tag

docs:
  extends: .generate_readme
  stage: .post

push_readme:
  extends: .push_readme
  stage: .post
  dependencies: ["docs"]
  needs: ["docs"]
